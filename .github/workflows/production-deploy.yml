name: ğŸš€ Production Deployment Orchestrator

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: true
        type: boolean

permissions:
  contents: read
  actions: write

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed: ${{ steps.changes.outputs.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        id: changes
        run: |
          # Check if this is a manual trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "frontend=${{ github.event.inputs.deploy_frontend || 'true' }}" >> $GITHUB_OUTPUT
            echo "backend=${{ github.event.inputs.deploy_backend || 'true' }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For push events, detect changes
          if git diff --name-only HEAD~1 HEAD | grep -E "^(src/|public/|index\.html|package\.json|package-lock\.json|vite\.config\.ts|tailwind\.config\.js|postcss\.config\.js)"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "No frontend changes detected"
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -E "^(backend/|Dockerfile|docker-compose\.yml|\.env\.example)"; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "No backend changes detected"
          fi

  trigger-backend:
    name: ğŸ—ï¸ Trigger Backend Deployment
    needs: detect-changes
    if: needs.detect-changes.outputs.backend-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger backend deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'backend-only-deploy.yml',
              ref: context.ref
            });
            
            console.log('ğŸ—ï¸ Backend deployment workflow triggered');
            console.log('ğŸ“‹ Workflow run will be visible in the Actions tab');
            return result;

  trigger-frontend:
    name: ğŸ¨ Trigger Frontend Deployment
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger frontend deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'frontend-only-deploy.yml',
              ref: context.ref
            });
            
            console.log('ğŸ¨ Frontend deployment workflow triggered');
            console.log('ğŸ“‹ Workflow run will be visible in the Actions tab');
            return result;

  deployment-summary:
    name: ğŸ‰ Deployment Summary
    needs: [detect-changes, trigger-backend, trigger-frontend]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment orchestration summary
        run: |
          echo "ğŸ‰ Production deployment orchestration completed!"
          echo ""
          echo "ğŸ“Š Deployment Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "${{ needs.detect-changes.outputs.backend-changed }}" = "true" ]; then
            if [ "${{ needs.trigger-backend.result }}" = "success" ]; then
              echo "ğŸ—ï¸  Backend: âœ… Deployment workflow triggered"
              echo "   ğŸ“‹ Check backend-only-deploy workflow for status"
            else
              echo "ğŸ—ï¸  Backend: âŒ Failed to trigger deployment workflow"
            fi
          else
            echo "ğŸ—ï¸  Backend: â­ï¸ No changes detected"
          fi
          
          if [ "${{ needs.detect-changes.outputs.frontend-changed }}" = "true" ]; then
            if [ "${{ needs.trigger-frontend.result }}" = "success" ]; then
              echo "ğŸ¨ Frontend: âœ… Deployment workflow triggered"
              echo "   ï¿½ Check frontend-only-deploy workflow for status"
            else
              echo "ğŸ¨ Frontend: âŒ Failed to trigger deployment workflow"
            fi
          else
            echo "ï¿½ Frontend: â­ï¸ No changes detected"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ• Orchestrated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "â„¹ï¸  Each deployment runs in its own workflow with independent error handling"
          echo "ğŸ“‹ View individual deployment status in the Actions tab"
