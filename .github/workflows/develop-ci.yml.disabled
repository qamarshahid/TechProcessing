name: Develop CI - Build and Test

on:
  push:
    branches: [ "develop" ]
    paths:
      - 'backend/src/**'
      - 'backend/package.json'
      - 'backend/package-lock.json'
      - 'backend/tsconfig*.json'
      - 'backend/nest-cli.json'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.*'
      - 'tsconfig*.json'
      - 'eslint.config.js'
      - 'Dockerfile'
      - 'docker-compose.yml'
  workflow_dispatch:

concurrency:
  group: develop-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (repo)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Lint with ESLint flat config
        run: npm run lint

  backend-test:
    name: Backend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- --ci
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: backend/test-results/**
          if-no-files-found: ignore

  backend-build:
    name: Backend build
    needs: [lint, backend-test]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        run: npm ci

      - name: Build backend
        run: npm run build

  frontend-build:
    name: Frontend build
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

  docker-build-check:
    name: Docker build (smoke)
    needs: [backend-build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker build
        run: docker build -t techprocessing-api:develop .

  success:
    name: âœ… All checks passed
    needs: [lint, backend-test, backend-build, frontend-build, docker-build-check]
    runs-on: ubuntu-latest
    steps:
      - name: Success message
        run: |
          echo "ðŸŽ‰ All CI checks passed successfully!"
          echo "âœ… Linting completed"
          echo "âœ… Backend tests passed"
          echo "âœ… Backend build successful"
          echo "âœ… Frontend build successful"
          echo "âœ… Docker build successful"
